---
title: "Example of using CreDating"
author: "Xavier Didelot"
date: '`r Sys.Date()`'
output:
  pdf_document: default
  html_notebook: default
---

##Initialisation

```{r}
library(CreDating)
library(ape)
set.seed(0)
```

##Data

We consider a random timed tree with 20 leaves, with the root in 2000. 

```{r}
nsam <- 20
phy <- rtree(nsam, br = rexp)
phy$root.time <- 2000
plot(phy)
axisPhylo(backward = F)
```

We can extract the sampling dates.
```{r}
dates = leafDates(phy)
#dates[seq(2,20,2)]=NA#Oops, just lost half of the dates!
dates[1]=NA#Oops, just lost a date!
```

On each branch we observe a number of substitutions which is distributed $\mathrm{Poisson}(rl)$
where $l$ is the branch length and 
$r=10$ per year is the real substitution rate.
```{r}
obsphy=phy
obsphy$root.time=NULL
#obsphy$edge.length=unlist(lapply(obsphy$edge.length*10,function (x) rpois(1,x)))
obsphy$edge.length=unlist(lapply(obsphy$edge.length*100,function (x) rgamma(1,x,1)))
res=roottotip(obsphy,dates,predInt='gamma',showTree=T)
```

##Unknown root
Let's say we don't know where the root is, we might consider as a guess that it is at
the midpoint:
```{r}
obsphy=phangorn::midpoint(obsphy)
res=roottotip(obsphy, dates, predInt = 'gamma', showTree = T)
```

##Analysis

We run CreDating as follows:

```{r}
res=credate(obsphy,dates,nbIts = 20000,model='gamma',findRoot = 2)
plot(res)
```

Plot with credibility bars:
```{r}
plot(res,'treeCI')
```


We can see what the MCMC traces look like:

```{r}
plot(res,'trace')
```
